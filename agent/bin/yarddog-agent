#!/usr/bin/env ruby
require 'socket'
require 'sinatra'
require 'docker'
require 'tmpdir'

PORT = 60086
set :port, PORT
set :bind, '0.0.0.0'
DIR = '/home/yarddog/workspace'

Dir.mkdir DIR unless Dir.exists? DIR
Dir.chdir DIR

Docker.validate_version!
images = Docker::Image.all

get '/test' do
    'This is a test. Seeing this message means ' \
    'the client is able to communicate with the server.'
end

# File upload
post '/images' do
    tempfile = params[:file][:tempfile]
    filename = params[:file][:filename]
    Dir.mktmpdir do |tempdir|
        STDOUT.puts tempdir
        unless system "tar -xz -f '#{tempfile.path}' -C '#{tempdir}'"
            return 500
        end
        # if the archive is entirely within one directory,
        # build the image there
        d = Dir.new(tempdir)
        e = d.entries - ['.','..']
        if e.size == 1 && File.directory?(e.first)
            d = Dir.new(e.first)
        end
        image = Docker::Image.build_from_dir(d)
    end
    "Created image #{image[:id]}."
end
